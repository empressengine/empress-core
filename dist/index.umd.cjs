(function(o,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(o=typeof globalThis<"u"?globalThis:o||self,p(o.EmpressCore={}))})(this,function(o){"use strict";class p{constructor(){this._groupId="",this._executionId="",this.withDisabled=!1}get groupId(){return this._groupId}get executionId(){return this._executionId}setContext(e,t,s){this._groupId=e,this._executionId=t,this._entityStorage=s}run(e,t,s){return this.externalFilter=t,this.withDisabled=s,this.execute(e)}filter(e){const t={includes:[...e.includes,...this.externalFilter.includes||[]],excludes:[...e.excludes||[],...this.externalFilter.excludes||[]]};return this._entityStorage.filter(t,this.withDisabled)}cleanFilter(e){return this._entityStorage.filter(e,this.withDisabled)}forceStop(){}}const y=class y{static uuid(){const e=Date.now();e!==this.lastTime&&(this.counter=0,this.lastTime=e);const t=(this.counter++).toString(36).padStart(2,"0"),s=Math.random().toString(36).slice(2,6);return`${e.toString(36)}-${t}-${s}`}static debounce(e,t=0){let s=null;return(...i)=>{clearTimeout(s),s=setTimeout(()=>{e(...i)},t)}}static createProxyDecorator(e){return new Proxy(e,{get:(t,s)=>{const i=t[s];return i instanceof Object?new Proxy(i,{}):i},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})}};y.counter=0,y.lastTime=0;let u=y;class P{constructor(){this._providers=[]}get providers(){return this._providers}add(e,t,s={}){const i=s.id||u.uuid(),n={...s,id:i,instance:{system:e,data:t}};return this._providers.push(n),this}prepend(e,t,s={}){const i=s.id||u.uuid(),n={...s,id:i,instance:{system:e,data:t}};return this._providers.unshift(n),this}insertBefore(e,t,s,i={}){const n=this._providers.findIndex(r=>r.id===e);if(n>=0){const r=i.id||u.uuid(),h={...i,id:r,instance:{system:t,data:s}};this._providers.splice(n,0,h)}return this}insertAfter(e,t,s,i={}){const n=this._providers.findIndex(r=>r.id===e);if(n>=0){const r=i.id||u.uuid(),h={...i,id:r,instance:{system:t,data:s}};this._providers.splice(n+1,0,h)}return this}replace(e,t,s,i={}){const n=this._providers.findIndex(r=>r.id===e);if(n>=0){const h={...Object.keys(i).length?i:this._providers[n],instance:{system:t,data:s}};this._providers[n]=h}return this}remove(e){const t=this._providers.findIndex(s=>s.id===e);return t>=0&&this._providers.splice(t,1),this}get(e){return this._providers.find(t=>t.id===e)}has(e){return this._providers.some(t=>t.id===e)}count(){return this._providers.length}clear(){this._providers.length=0}}class I{constructor(){this._uuid=u.uuid(),this._chain=new P}get uuid(){return this._uuid}get chain(){return this._chain}set chain(e){this._chain=e}sorted(e){this._chain.clear(),this.setup(this._chain,e);const t=this._chain.providers;return t.forEach(s=>{s.withDisabled===void 0&&(s.withDisabled=!1),s.includes===void 0&&(s.includes=[]),s.excludes===void 0&&(s.excludes=[]),s.repeat||(s.repeat=1),s.canExecute||(s.canExecute=()=>!0)}),t}registerGroupDependencies(){const e=this.setupDependencies();c.instance.registerModule(this.uuid,e)}setupDependencies(){return[]}}class c{constructor(){this.providers=new Map,this.instances=new Map,this.systemTokens=[],this.providers.set("global",new Map),this.instances.set("global",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}registerModule(e,t){this.providers.has(e)||(this.providers.set(e,new Map),this.instances.set(e,new Map));const s=this.providers.get(e);for(const i of t)s.set(i.provide,i)}registerGlobal(e){this.registerModule("global",e)}get(e,t="global"){var r;let s=((r=this.providers.get(t))==null?void 0:r.get(e))??this.providers.get("global").get(e);if(!s)throw new Error(`Provider for token ${e.toString()} not found`);const i=this.instances.get(t==="global"?"global":t);if(i.has(e))return i.get(e);const n="useClass"in s?typeof s.useClass=="function"?new s.useClass:s.useClass:s.useFactory();return i.set(e,n),n}memorizeSystem(e,t,s){this.systemTokens.push({system:e,token:t,key:s})}getDependencyForSystem(e,t){if(!("injectHere"in t))return;const s=[];for(const i of this.systemTokens)t instanceof i.system&&s.push({token:i.token,key:i.key});s.forEach(i=>{var n,r;if(i.key in t){const h=this.providers.get("global").has(i.token),d=(n=this.providers.get(e))==null?void 0:n.has(i.token);if(!d&&!h)return;let m,f;if(d?(m=(r=this.providers.get(e))==null?void 0:r.get(i.token),f=e):h&&(m=this.providers.get("global").get(i.token),f="global"),!m)return;let E=this.get(i.token,f);m.immutable&&(E=new Proxy(E,{get:(z,L)=>{const q=z[L];return q instanceof Object?new Proxy(q,{}):q},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})),Object.defineProperty(t,i.key,{value:E,enumerable:!0,configurable:!0})}})}}function j(a){if(!a)throw new Error("Token must be provided to @Inject decorator when not using reflect-metadata");return function(e,t){let s="global";if(e instanceof p){Object.defineProperty(e,"injectHere",{value:"injectHere",enumerable:!1,configurable:!1}),Object.defineProperty(e,t,{value:null}),c.instance.memorizeSystem(e.constructor,a,t);return}e instanceof I&&(s=e.uuid||"global"),Object.defineProperty(e,t,{get:()=>c.instance.get(a,s),enumerable:!0,configurable:!1})}}class v{constructor(){this._cache=new Map}get(e){let t=this._cache.get(e);return t||(t=new e,this._cache.set(e,t)),t}}class F{constructor(){this._cache=new Map}get(e){let t=this._cache.get(e);return t||(t=new e,t.registerGroupDependencies(),this._cache.set(e,t)),t}}const O=(a,e)=>t=>!(!t.hasComponents(a)||e&&t.hasComponents(e));class M{constructor(e=[]){this._entities=e}get count(){return this._entities.length}get items(){return this._entities}forEach(e){for(let t=0;t<this._entities.length;t++)e(this._entities[t],t)}async sequential(e){let t=0;for(const s of this._entities)await e(s,t),t+=1}async parallel(e){const t=this._entities.map(e);await Promise.all(t)}}const x=class x{static increment(e){const t=this._componentFrequency.get(e)??0;this._componentFrequency.set(e,t+1)}static decrement(e){const t=this._componentFrequency.get(e)??0;t>1?this._componentFrequency.set(e,t-1):this._componentFrequency.delete(e)}static rarity(e){return this._componentFrequency.get(e)??0}static sortByRarity(e){return[...e].sort((t,s)=>this.rarity(t)-this.rarity(s))}};x._componentFrequency=new Map;let l=x;class C{constructor(){this._entities=new Map}addEntity(e){const{uuid:t,name:s}=e;if(this._entities.has(t))throw new Error(`Entity with UUID [${s}-${t}] already exists in the storage.`);this._entities.set(t,e)}removeEntity(e){const t=this._entities.get(e);if(t)return this._entities.delete(e),t}getEntity(e){return this._entities.get(e)}getAllEntities(){return Array.from(this._entities.values())}getActiveEntities(){return Array.from(this._entities.values()).filter(e=>e.active)}getInactiveEntities(){return Array.from(this._entities.values()).filter(e=>!e.active)}filter(e,t){let s=t?this.getAllEntities():this.getActiveEntities();if(e.excludes||(e.excludes=[]),e!=null&&e.includes.length||e!=null&&e.excludes.length){const i=l.sortByRarity(e.includes),n=e.excludes.length?l.sortByRarity(e.excludes):void 0,r=O(i,n);s=s.filter(r)}return new M(s)}}class G{constructor(e,t,s,i,n){this._id=e,this._systemsContainer=t,this._groupsContainer=s,this._entityStorage=i,this._name=n,this._queue=[],this._currentSystem=null,this._isPaused=!1,this._resumePromise=null,this._resolveResume=null,this._abortController=null}get id(){return this._id}get name(){return this._name}setup(e,t){this._queue=this.getExecutionQueue(e,t)}async execute(e=!0){this._abortController=new AbortController;try{for(;this._queue.length>0&&(this._isPaused&&await this.waitForResume(),!this._abortController.signal.aborted);){const t=this._queue.shift();if(t&&t.canExecute()){const i={includes:t.includes,excludes:t.excludes};t.system.setContext(t.groupId,t.executionId,this._entityStorage),c.instance.getDependencyForSystem(t.groupId,t.system),this._currentSystem=t.system;const n=t.system.run(t.data,i,t.withDisabled);if(n instanceof Promise)if(e)await Promise.race([n,new Promise((r,h)=>{this._abortController.signal.addEventListener("abort",()=>{h(new Error("Queue execution was stopped"))})})]);else throw new Error(`Execution of asynchronous system '${t.system.constructor.name}' in queue '${this.name}' is prohibited!`);this._currentSystem=null}}}catch(t){if(t instanceof Error&&t.message==="Queue execution was stopped")return;throw t}}stop(){var e;this._queue=[],(e=this._currentSystem)==null||e.forceStop(),this._abortController&&(this._abortController.abort(),this._abortController=null)}pause(){this._isPaused||(this._isPaused=!0)}resume(){this._isPaused&&(this._isPaused=!1,this._resolveResume&&(this._resolveResume(),this._resolveResume=null,this._resumePromise=null))}waitForResume(){return this._resumePromise||(this._resumePromise=new Promise(e=>{this._resolveResume=e})),this._resumePromise}getExecutionQueue(e,t){const s=e.map(n=>this._groupsContainer.get(n)),i=[];return s.forEach(n=>{const r=n.sorted(t),h=n.uuid;r.forEach(d=>{const m=this._systemsContainer.get(d.instance.system);for(let f=0;f<d.repeat;f++)i.push({...d,groupId:h,data:d.instance.data,executionId:this._id,system:m})})}),i}}class w{constructor(e,t,s){this._systemsContainer=e,this._groupsContainer=t,this._entityStorage=s,this._queues=new Map}get activeQueues(){return Array.from(this._queues.keys())}get queueSize(){return this._queues.size}create(e,t,s="unnamed"){const i=new G(u.uuid(),this._systemsContainer,this._groupsContainer,this._entityStorage,s);return i.setup(e,t),this._queues.set(i.id,i),i.id}async run(e,t=!0){const s=this._queues.get(e);if(!s)throw new Error(`Queue with id ${e} not found`);await s.execute(t),this._queues.delete(s.id)}stop(e){const t=this._queues.get(e);t&&(t.stop(),this._queues.delete(e))}pause(e){const t=this._queues.get(e);t&&t.pause()}resume(e){const t=this._queues.get(e);t&&t.resume()}stopAll(){this._queues.forEach(e=>{e.stop()}),this._queues.clear()}pauseAll(){this._queues.forEach(e=>{e.pause()})}resumeAll(){this._queues.forEach(e=>{e.resume()})}hasQueue(e){return this._queues.has(e)}getQueueStatus(e){const t=this._queues.get(e);return t?{isPaused:t._isPaused}:null}}class T{constructor(e=[]){this._existingProviders=e,this._providers=[],this._providers=[...e]}get providers(){return[...this._providers]}add(e,t){const s=t||u.uuid();return this._providers.push({id:s,group:e}),this}prepend(e,t){const s=t||u.uuid();return this._providers.unshift({id:s,group:e}),this}insertBefore(e,t,s){const i=this._providers.findIndex(n=>n.id===e);if(i>=0){const n=s||u.uuid();this._providers.splice(i,0,{id:n,group:t})}return this}insertAfter(e,t,s){const i=this._providers.findIndex(n=>n.id===e);if(i>=0){const n=s||u.uuid();this._providers.splice(i+1,0,{id:n,group:t})}return this}replace(e,t){const s=this._providers.findIndex(i=>i.id===e);return s>=0&&(this._providers[s]={id:e,group:t}),this}remove(e){const t=this._providers.findIndex(s=>s.id===e);return t>=0&&this._providers.splice(t,1),this}}class _{constructor(e){this._executionController=e,this._pairs=new Map,this._disposables=new Map,this._executionIds=[]}setup(e){for(let t of e){const s=this._pairs.get(t.signal)||[],i=t.groups.map(n=>({id:u.uuid(),group:n}));s.push(...i),this._pairs.set(t.signal,s)}}subscribe(){this.unsubscribe();for(const e of this._pairs.keys())this._subscribeSignal(e)}unsubscribe(){this._disposables.forEach(e=>e.dispose()),this._disposables.clear(),this._executionIds.forEach(e=>this._executionController.stop(e)),this._executionIds.length=0}configure(e,t){var n;this._disposables.has(e)&&((n=this._disposables.get(e))==null||n.dispose(),this._disposables.delete(e));const s=this._pairs.get(e)||[],i=new T(s);t(i),this._pairs.set(e,i.providers),this._subscribeSignal(e)}_subscribeSignal(e){const s=(this._pairs.get(e)||[]).map(n=>n.group),i=e.subscribe(n=>{const r=this._executionController.create(s,n,e.name);this._executionController.run(r),this._executionIds.push(r)});this._disposables.set(e,i)}}class U{constructor(e,t,s,i){this._uuid=e,this._timerController=t,this._onComplete=s,this._duration=i,this._elapsedTime=0}get uuid(){return this._uuid}update(e){this._elapsedTime+=e*1e3,this._elapsedTime>=this._duration&&(this._onComplete(),this._timerController.clear(this.uuid))}}class Q{constructor(e,t,s){this._uuid=e,this._onComplete=t,this._duration=s,this._elapsedTime=0}get uuid(){return this._uuid}onComplete(){return this._onComplete}update(e){this._elapsedTime+=e*1e3,this._elapsedTime>=this._duration&&(this._elapsedTime=0,this._onComplete())}}class A{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}static resolveAll(e,t){e.forEach(s=>s.resolve(t))}static rejectAll(e,t){e.forEach(s=>s.reject(t))}static all(e){return Promise.all(e.map(t=>t.promise))}static allSettled(e){return Promise.allSettled(e.map(t=>t.promise))}static race(e){return Promise.race(e.map(t=>t.promise))}}class b{constructor(){this._updatables=new Map}setTimeout(e,t){const s=u.uuid(),i=new U(s,this,e,t);return this._updatables.set(s,i),s}setInterval(e,t){const s=u.uuid(),i=new Q(s,e,t);return this._updatables.set(s,i),s}sleep(e){const t=new A,s=this.setTimeout(()=>t.resolve(),e);return{id:s,wait:async()=>await t.promise,resolve:()=>{t.resolve(),this.clear(s)}}}clear(e){this._updatables.has(e)&&this._updatables.delete(e)}update(e){Array.from(this._updatables.values()).forEach(s=>s.update(e))}}class S{constructor(e="Signal"){this._name=e,this.listeners=[],this._uuid=u.uuid()}get name(){return this._name}get uuid(){return this._uuid}subscribe(e){return this.listeners.push({callback:e,once:!1}),{dispose:()=>{this.unsubscribe(e)}}}once(e){return this.listeners.push({callback:e,once:!0}),{dispose:()=>{this.unsubscribe(e)}}}unsubscribe(e){this.listeners=this.listeners.filter(t=>t.callback!==e)}async dispatch(e){const t=[],s=[];for(const i of this.listeners){const n=i.callback(e);n instanceof Promise&&s.push(n),i.once&&t.push(i.callback)}await Promise.all(s),t.length>0&&(this.listeners=this.listeners.filter(i=>!t.includes(i.callback)))}}const D=new S,$=new S;class g{constructor(){this._lastTime=0,this._paused=!1,this._speedMultiplier=1,this._onUpdate=[],this._onStart=[],this.animate=e=>{if(!this._paused){if(this._lastTime!==0){const t=(e-this._lastTime)/1e3;this.update(t)}this._lastTime=e,requestAnimationFrame(this.animate)}}}start(){this._onStart.forEach(e=>e()),D.dispatch(),requestAnimationFrame(this.animate)}addStartCallback(e){this._onStart.push(e)}addUpdateCallback(e){this._onUpdate.push(e)}removeUpdateCallback(e){this._onUpdate=this._onUpdate.filter(t=>t!==e)}pause(e){this._paused=e}setSpeedMultiplier(e){this._speedMultiplier=e}update(e){if(this._paused)return;const t=e*this._speedMultiplier;this._onUpdate.forEach(s=>s(t)),$.dispatch({deltaTime:e,speedMultiplier:this._speedMultiplier,multipliedDelta:t})}}class R{init(){this.registerServices();const e=c.instance.get(g),t=c.instance.get(b);e.addUpdateCallback(s=>{t.update(s)})}start(){c.instance.get(g).start()}listenSignals(e){c.instance.get(_).setup(e)}configureSignal(e,t){c.instance.get(_).configure(e,t)}subscribe(){c.instance.get(_).subscribe()}registerGlobalServices(e){c.instance.registerGlobal(e)}registerServices(){const e=new C,t=new v,s=new F,i=new g,n=new b,r=new w(t,s,e),h=new _(r);this.registerGlobalServices([{provide:C,useFactory:()=>e},{provide:v,useFactory:()=>t},{provide:g,useFactory:()=>i},{provide:b,useFactory:()=>n},{provide:w,useFactory:()=>r},{provide:_,useFactory:()=>h}])}}class k{constructor(){this._items=[]}get items(){return this._items}set(e){this._items.push(e)}get(e){return this._items.find(t=>t instanceof e)}has(e){return!!this.get(e)}delete(e){const t=this.get(e);return t&&(this._items=this.items.filter(s=>s.constructor!==e)),!!t}clear(){this._items.length=0}}class B{constructor(e,t="Entity"){this._uuid=e,this._name=t,this._active=!0,this._components=new k,this._disabledComponents=new k}get uuid(){return this._uuid}get name(){return this._name}set name(e){this._name=e}get active(){return this._active}set active(e){this._active=e}get components(){return this._components.items}get disabledComponents(){return this._disabledComponents.items}addComponent(e,t=!0){const s=this.extractConstructor(e);if(this._components.has(s)||this._disabledComponents.has(s))throw new Error(`Component of type ${s.name} already exists in entity [${this._name}-${this._uuid}]`);t?(this._components.set(e),l.increment(s)):(this._disabledComponents.set(e),l.decrement(s))}getComponent(e){const t=this._components.get(e);if(!t)throw new Error(`Component of type ${e.name} is not found in [${this.name}-${this.uuid}].`);return t}hasComponents(e){return e.every(t=>!!this._components.get(t))}removeComponent(e){let t;if(this._components.has(e)?(t=this._components.get(e),this._components.delete(e)):this._disabledComponents.has(e)&&(t=this._disabledComponents.get(e),this._disabledComponents.delete(e)),!t)throw new Error(`Component type ${e.name} does not exist in entity [${this._name}-${this._uuid}]`);return l.decrement(e),t}enableComponent(e){if(!this._disabledComponents.has(e))throw new Error(`Cannot enable component of type ${e.name} - it does not exist or is already enabled.`);const t=this._disabledComponents.get(e);this._disabledComponents.delete(e),this._components.set(t),l.increment(e)}disableComponent(e){if(!this._components.has(e))throw new Error(`Cannot disable component of type ${e.name} - it does not exist or is already disabled.`);const t=this._components.get(e);this._components.delete(e),this._disabledComponents.set(t),l.decrement(e)}disableAllComponents(){for(const e of this._components.items)this._disabledComponents.set(e),l.decrement(e.constructor);this._components.clear()}enableAllComponents(){for(const e of this._disabledComponents.items)this._components.set(e),l.increment(e.constructor);this._disabledComponents.clear()}isSatisfiedFilter(e){const t=e.includes||[],s=e.excludes||[];return this.hasComponents(t)&&(!s.length||!this.hasComponents(s))}extractConstructor(e){return e.constructor}}o.ComponentsRaritySorter=l,o.DeferredPromise=A,o.EmpressCore=R,o.Entity=B,o.EntityStorage=C,o.ExecutionController=w,o.Filtered=M,o.GroupsContainer=F,o.Inject=j,o.LifeCycle=g,o.OnStartSignal=D,o.OnUpdateSignal=$,o.ServiceContainer=c,o.Signal=S,o.SignalChain=T,o.SignalsController=_,o.System=p,o.SystemChain=P,o.SystemGroup=I,o.SystemsContainer=v,o.TimerController=b,o.Utils=u,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
